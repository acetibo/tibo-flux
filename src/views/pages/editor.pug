extends ../layouts/layout

block styles
  //- CodeMirror CSS
  link(rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css")
  link(rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material-darker.min.css")
  style.
    .editor-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      height: 500px;
    }
    .editor-container > div {
      min-height: 0;
      overflow: hidden;
    }
    /* CodeMirror dans le conteneur flex */
    .CodeMirror {
      flex: 1;
      height: auto;
      font-family: 'Fira Code', 'Consolas', monospace;
      font-size: 14px;
      border-radius: 0 0 0.5rem 0.5rem;
    }
    /* Couleurs custom TiboFlux */
    .cm-s-material-darker .cm-tiboflux-keyword { color: #c792ea; font-weight: bold; }
    .cm-s-material-darker .cm-tiboflux-terminal { color: #89ddff; }
    .cm-s-material-darker .cm-tiboflux-process { color: #82aaff; }
    .cm-s-material-darker .cm-tiboflux-decision { color: #ffcb6b; }
    .cm-s-material-darker .cm-tiboflux-io { color: #c3e88d; }
    .cm-s-material-darker .cm-tiboflux-arrow { color: #89ddff; font-weight: bold; }
    .cm-s-material-darker .cm-tiboflux-pipe { color: #f78c6c; font-weight: bold; }
    .cm-s-material-darker .cm-tiboflux-string { color: #c3e88d; }
    .cm-s-material-darker .cm-tiboflux-comment { color: #546e7a; font-style: italic; }
    .cm-s-material-darker .cm-tiboflux-modifier { color: #ff5370; }
    .cm-s-material-darker .cm-tiboflux-header { color: #c792ea; }
    #preview-container {
      background: #fff;
      background-image:
        linear-gradient(rgba(0,0,0,0.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0,0,0,0.05) 1px, transparent 1px);
      background-size: 20px 20px;
    }
    #preview-svg {
      max-height: 100%;
      overflow: auto;
      align-items: flex-start !important;
      justify-content: flex-start !important;
      padding: 1rem;
    }
    #preview-svg svg {
      max-width: 100%;
      height: auto;
    }
    #preview-svg p {
      margin: auto;
    }
    #console {
      white-space: pre-wrap;
      word-break: break-word;
    }

block content
  //- Barre de gestion des fichiers
  .mb-4.bg-white.rounded-lg.shadow.p-3.flex.items-center.justify-between.flex-wrap.gap-2
    .flex.items-center.gap-2
      //- Nouveau (ouvre modale)
      button#btn-new(class="bg-gray-100 text-gray-700 px-3 py-2 rounded hover:bg-gray-200 transition text-sm")
        | + Nouveau

      //- Ouvrir (ouvre modale)
      button#btn-open(class="bg-gray-100 text-gray-700 px-3 py-2 rounded hover:bg-gray-200 transition text-sm")
        | Ouvrir

      //- Sauvegarder
      button#btn-save.px-3.py-2.rounded.text-sm(style="background:#2563eb;color:white")
        | Sauvegarder

      //- Supprimer
      button#btn-delete.px-3.py-2.rounded.text-sm.hidden(style="background:#fee2e2;color:#dc2626")
        | Supprimer

    //- Indicateur fichier courant
    .flex.items-center.gap-2
      span#current-file.text-sm.text-gray-500.italic Nouveau document
      span#file-modified.text-xs.text-orange-500.hidden (non sauvegardÃ©)

  //- Barre principale
  .mb-4.flex.items-center.justify-between
    h1.text-2xl.font-bold.text-gray-800 Ã‰diteur TiboFlux
    .flex.gap-2
      button#btn-render.px-4.py-2.rounded(style="background:#4f46e5;color:white")
        | GÃ©nÃ©rer
      button#btn-export.px-4.py-2.rounded(style="background:#16a34a;color:white")
        | Exporter

  .editor-container
    .flex.flex-col
      //- Onglets Ã©diteur
      .flex.bg-gray-700.rounded-t
        button#tab-code.px-4.py-2.text-sm.font-medium.rounded-tl.transition(class="bg-gray-800 text-white")
          | Code TiboFlux
        button#tab-context.px-4.py-2.text-sm.font-medium.transition(class="bg-gray-600 text-gray-300 hover:bg-gray-700")
          | Contexte
        //- Bouton aide syntaxe
        button#btn-help.ml-auto.px-3.py-1.text-xs.mr-2.my-1.rounded.transition(class="bg-gray-600 text-gray-300 hover:bg-gray-500")
          | ? Aide syntaxe
      //- Panneau Code
      #code-editor-wrapper.flex-1.bg-gray-900
        textarea#code-editor.hidden
          | # Exemple de diagramme
          | flow "Processus de commande"
          |
          | [DÃ©but] -> {VÃ©rifier stock}
          |
          | {VÃ©rifier stock} -> <Disponible?>
          |
          | <Disponible?>
          |   | oui -> {Traiter paiement} -> {ExpÃ©dier} -> [Fin]
          |   | non -> {Notifier client} -> [Fin]
      //- Panneau Contexte (cachÃ© par dÃ©faut)
      #panel-context.flex-1.bg-gray-900.p-4.hidden
        textarea#context-editor.w-full.h-full.p-3.rounded.resize-none.text-sm(style="background:#1e1e1e;color:#e0e0e0;border:1px solid #333" placeholder="DÃ©crivez le contexte de ce diagramme : objectif, destinataires, remarques...")

    .flex.flex-col
      .bg-gray-200.px-3.py-1.text-sm.rounded-t.flex.justify-between.items-center
        span AperÃ§u
        span#status.text-xs.text-gray-500 PrÃªt
      #preview-container.flex-1.rounded-b.border.border-gray-300.overflow-auto.flex.items-center.justify-center
        #preview-svg.w-full.h-full.flex.items-center.justify-center
          p.text-gray-400 Cliquez sur "GÃ©nÃ©rer" pour voir l'aperÃ§u

  //- Modale Nouveau (templates)
  #modal-new.hidden(style="position:fixed;top:0;left:0;right:0;bottom:0;z-index:9999")
    div(style="position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5)" onclick="closeModal('new')")
    div(style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:white;border-radius:0.5rem;width:100%;max-width:32rem;max-height:80vh;overflow:hidden;box-shadow:0 25px 50px -12px rgba(0,0,0,0.25)")
      .flex.items-center.justify-between.px-6.py-4.border-b
        h2.text-xl.font-bold.text-gray-800 Nouveau document
        button.text-gray-400.text-2xl.cursor-pointer(onclick="closeModal('new')" style="line-height:1") &times;
      #templates-content.p-6(style="overflow:auto;max-height:60vh")
        .text-gray-500 Chargement...

  //- Modale Ouvrir (documents)
  #modal-open.hidden(style="position:fixed;top:0;left:0;right:0;bottom:0;z-index:9999")
    div(style="position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5)" onclick="closeModal('open')")
    div(style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:white;border-radius:0.5rem;width:100%;max-width:32rem;max-height:80vh;overflow:hidden;box-shadow:0 25px 50px -12px rgba(0,0,0,0.25)")
      .flex.items-center.justify-between.px-6.py-4.border-b
        h2.text-xl.font-bold.text-gray-800 Ouvrir un document
        button.text-gray-400.text-2xl.cursor-pointer(onclick="closeModal('open')" style="line-height:1") &times;
      #documents-content.p-6(style="overflow:auto;max-height:60vh")
        .text-gray-500 Chargement...

  //- Modale Exporter
  #modal-export.hidden(style="position:fixed;top:0;left:0;right:0;bottom:0;z-index:9999")
    div(style="position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5)" onclick="closeModal('export')")
    div(style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:white;border-radius:0.5rem;width:100%;max-width:32rem;max-height:80vh;overflow:hidden;box-shadow:0 25px 50px -12px rgba(0,0,0,0.25)")
      .flex.items-center.justify-between.px-6.py-4.border-b
        h2.text-xl.font-bold.text-gray-800 Exporter
        button.text-gray-400.text-2xl.cursor-pointer(onclick="closeModal('export')" style="line-height:1") &times;
      .p-6
        //- Diagrammes
        .mb-4
          h3.text-sm.font-semibold.text-gray-500.mb-2 Diagrammes
          .grid.gap-2
            button.export-btn.text-left.p-3.border.rounded-lg(data-format="svg" style="transition:all 0.2s")
              .font-medium.text-gray-800 SVG
              .text-xs.text-gray-500 Image vectorielle (qualitÃ© parfaite)
            button.export-btn.text-left.p-3.border.rounded-lg(data-format="png" style="transition:all 0.2s")
              .font-medium.text-gray-800 PNG
              .text-xs.text-gray-500 Image bitmap (compatible partout)
            button.export-btn.text-left.p-3.border.rounded-lg(data-format="pdf" style="transition:all 0.2s")
              .font-medium.text-gray-800 PDF
              .text-xs.text-gray-500 Document imprimable
            button.export-btn.text-left.p-3.border.rounded-lg(data-format="json" style="transition:all 0.2s")
              .font-medium.text-gray-800 JSON (AST)
              .text-xs.text-gray-500 Structure de donnÃ©es brute
        //- Tableaux
        .mb-4
          h3.text-sm.font-semibold.text-gray-500.mb-2 Tableaux (texte)
          .grid.gap-2
            button.export-table-btn.text-left.p-3.border.rounded-lg(data-table-format="ascii" style="transition:all 0.2s")
              .font-medium.text-gray-800 ASCII art
              .text-xs.text-gray-500 Texte brut avec bordures
            button.export-table-btn.text-left.p-3.border.rounded-lg(data-table-format="markdown" style="transition:all 0.2s")
              .font-medium.text-gray-800 Markdown
              .text-xs.text-gray-500 Pour documentation (GitHub, etc.)
            button.export-table-btn.text-left.p-3.border.rounded-lg(data-table-format="html" style="transition:all 0.2s")
              .font-medium.text-gray-800 HTML
              .text-xs.text-gray-500 Page web autonome
        //- Swimlanes
        .mb-2
          h3.text-sm.font-semibold.text-gray-500.mb-2 Swimlanes (texte)
          .grid.gap-2
            button.export-swimlane-btn.text-left.p-3.border.rounded-lg(data-swimlane-format="ascii" style="transition:all 0.2s")
              .font-medium.text-gray-800 ASCII art
              .text-xs.text-gray-500 Diagramme multi-acteurs en texte

  //- Modale Aide Syntaxe
  #modal-help.hidden(style="position:fixed;top:0;left:0;right:0;bottom:0;z-index:9999")
    div(style="position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5)" onclick="closeModal('help')")
    div(style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:white;border-radius:0.5rem;width:100%;max-width:40rem;max-height:85vh;overflow:hidden;box-shadow:0 25px 50px -12px rgba(0,0,0,0.25)")
      .flex.items-center.justify-between.px-6.py-4.border-b
        h2.text-xl.font-bold.text-gray-800 Aide Syntaxe TiboFlux
        button.text-gray-400.text-2xl.cursor-pointer(onclick="closeModal('help')" style="line-height:1") &times;
      .p-6(style="overflow:auto;max-height:70vh")
        //- Flowcharts
        .mb-6
          h3.text-lg.font-semibold.text-indigo-600.mb-3 Flowcharts
          .bg-gray-50.rounded-lg.p-4.text-sm
            .grid.grid-cols-2.gap-4
              div
                .font-medium.text-gray-700.mb-1 Mots-clÃ©s
                code.bg-gray-200.px-2.py-1.rounded.text-xs flow "Titre"
              div
                .font-medium.text-gray-700.mb-1 Connexion
                code.bg-gray-200.px-2.py-1.rounded.text-xs ->
            .mt-4
              .font-medium.text-gray-700.mb-2 Types de noeuds
              .grid.grid-cols-2.gap-2
                .flex.items-center.gap-2
                  code.bg-blue-100.text-blue-800.px-2.py-1.rounded.text-xs [Texte]
                  span.text-gray-600.text-xs Terminal (debut/fin)
                .flex.items-center.gap-2
                  code.bg-green-100.text-green-800.px-2.py-1.rounded.text-xs {Texte}
                  span.text-gray-600.text-xs Processus
                .flex.items-center.gap-2
                  code.bg-yellow-100.text-yellow-800.px-2.py-1.rounded.text-xs <Texte?>
                  span.text-gray-600.text-xs Decision
                .flex.items-center.gap-2
                  code.bg-purple-100.text-purple-800.px-2.py-1.rounded.text-xs (Texte)
                  span.text-gray-600.text-xs Entree/Sortie
            .mt-4
              .font-medium.text-gray-700.mb-2 Branches conditionnelles
              pre.bg-gray-200.p-2.rounded.text-xs.overflow-x-auto
                | &lt;Question?&gt;
                |   | oui -> {Action1}
                |   | non -> {Action2}
        //- Tableaux
        .mb-6
          h3.text-lg.font-semibold.text-indigo-600.mb-3 Tableaux
          .bg-gray-50.rounded-lg.p-4.text-sm
            .mb-3
              .font-medium.text-gray-700.mb-1 Structure de base
              pre.bg-gray-200.p-2.rounded.text-xs.overflow-x-auto
                | table "Titre"
                |   | header | Col1 | Col2 |
                |   | Ligne1 | A | B |
            .mb-3
              .font-medium.text-gray-700.mb-2 Modificateurs de cellules
              .grid.grid-cols-2.gap-2
                .flex.items-center.gap-2
                  code.bg-red-100.text-red-800.px-2.py-1.rounded.text-xs :c2
                  span.text-gray-600.text-xs Colspan (2 colonnes)
                .flex.items-center.gap-2
                  code.bg-red-100.text-red-800.px-2.py-1.rounded.text-xs :r3
                  span.text-gray-600.text-xs Rowspan (3 lignes)
                .flex.items-center.gap-2
                  code.bg-orange-100.text-orange-800.px-2.py-1.rounded.text-xs :al
                  span.text-gray-600.text-xs Aligner a gauche
                .flex.items-center.gap-2
                  code.bg-orange-100.text-orange-800.px-2.py-1.rounded.text-xs :ac
                  span.text-gray-600.text-xs Aligner au centre
                .flex.items-center.gap-2
                  code.bg-orange-100.text-orange-800.px-2.py-1.rounded.text-xs :ar
                  span.text-gray-600.text-xs Aligner a droite
                .flex.items-center.gap-2
                  code.bg-gray-300.text-gray-700.px-2.py-1.rounded.text-xs -
                  span.text-gray-600.text-xs Cellule couverte
            .mt-3
              .font-medium.text-gray-700.mb-2 Exemple complet
              pre.bg-gray-200.p-2.rounded.text-xs.overflow-x-auto
                | table "Budget"
                |   | header | Poste | Montant:ar |
                |   | Hebergement:al | 500 EUR:ar |
                |   | Total:c2 |
        //- Commentaires
        div
          h3.text-lg.font-semibold.text-indigo-600.mb-3 Commentaires
          .bg-gray-50.rounded-lg.p-4.text-sm
            code.bg-gray-200.px-2.py-1.rounded.text-xs # Ceci est un commentaire

  .mt-4.bg-white.rounded-lg.shadow
    .flex.items-center.justify-between.px-4.py-2.cursor-pointer#console-header
      .flex.items-center.gap-2
        span#console-icon.text-gray-400.transition-transform â–¶
        h3.font-semibold.text-gray-700.text-sm Console
        span#console-badge(class="hidden bg-red-500 text-white text-xs px-2 py-0.5 rounded-full") 0
      span.text-xs.text-gray-400 Cliquez pour afficher/masquer
    #console-wrapper.hidden.px-4.pb-4
      pre#console.bg-gray-900.text-gray-300.p-3.rounded.h-32.overflow-auto.text-sm

block scripts
  //- CodeMirror JS
  script(src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js")
  script.
    // === Mode TiboFlux pour CodeMirror ===
    (function(CodeMirror) {
      CodeMirror.defineMode("tiboflux", function() {
        return {
          startState: function() {
            return { inString: false, inNode: null };
          },
          token: function(stream, state) {
            // Espaces
            if (stream.eatSpace()) return null;

            // Commentaires
            if (stream.match(/^#.*/)) {
              return "tiboflux-comment";
            }

            // Strings "..."
            if (stream.match(/^"[^"]*"/)) {
              return "tiboflux-string";
            }

            // Mots-clÃ©s
            if (stream.match(/^(flow|table)\b/)) {
              return "tiboflux-keyword";
            }

            // header (dans les tableaux)
            if (stream.match(/^header\b/)) {
              return "tiboflux-header";
            }

            // Modificateurs :cN :rN
            if (stream.match(/^:[rc]\d+/)) {
              return "tiboflux-modifier";
            }

            // FlÃ¨ches
            if (stream.match(/^-->?/)) {
              return "tiboflux-arrow";
            }

            // Pipe
            if (stream.match(/^\|/)) {
              return "tiboflux-pipe";
            }

            // Terminal [...]
            if (stream.match(/^\[[^\]]*\]/)) {
              return "tiboflux-terminal";
            }

            // Process {...}
            if (stream.match(/^\{[^}]*\}/)) {
              return "tiboflux-process";
            }

            // Decision <...>
            if (stream.match(/^<[^>]*>/)) {
              return "tiboflux-decision";
            }

            // I/O (...)
            if (stream.match(/^\([^)]*\)/)) {
              return "tiboflux-io";
            }

            // Autres caractÃ¨res
            stream.next();
            return null;
          }
        };
      });
    })(CodeMirror);

    // === Ã‰lÃ©ments DOM ===
    const codeEditorTextarea = document.getElementById('code-editor');
    const previewSvg = document.getElementById('preview-svg');
    const consoleEl = document.getElementById('console');
    const statusEl = document.getElementById('status');
    const consoleWrapper = document.getElementById('console-wrapper');
    const consoleHeader = document.getElementById('console-header');
    const consoleIcon = document.getElementById('console-icon');
    const consoleBadge = document.getElementById('console-badge');
    const currentFileEl = document.getElementById('current-file');
    const fileModifiedEl = document.getElementById('file-modified');
    const btnNew = document.getElementById('btn-new');
    const btnOpen = document.getElementById('btn-open');
    const btnSave = document.getElementById('btn-save');
    const btnDelete = document.getElementById('btn-delete');
    const modalNew = document.getElementById('modal-new');
    const modalOpen = document.getElementById('modal-open');
    const modalExport = document.getElementById('modal-export');
    const modalHelp = document.getElementById('modal-help');
    const templatesContent = document.getElementById('templates-content');
    const documentsContent = document.getElementById('documents-content');
    const tabCode = document.getElementById('tab-code');
    const tabContext = document.getElementById('tab-context');
    const panelCode = document.getElementById('code-editor-wrapper');
    const panelContext = document.getElementById('panel-context');
    const contextEditor = document.getElementById('context-editor');
    const btnHelp = document.getElementById('btn-help');

    let errorCount = 0;
    let currentDocument = null; // { id, name, code, type, context }
    let originalCode = '';
    let originalContext = '';

    // === Gestion des onglets Code/Contexte ===
    function switchTab(tab) {
      if (tab === 'code') {
        tabCode.classList.remove('bg-gray-600', 'text-gray-300');
        tabCode.classList.add('bg-gray-800', 'text-white');
        tabContext.classList.remove('bg-gray-800', 'text-white');
        tabContext.classList.add('bg-gray-600', 'text-gray-300');
        panelCode.classList.remove('hidden');
        panelContext.classList.add('hidden');
        editor.refresh(); // Refresh CodeMirror aprÃ¨s affichage
      } else {
        tabContext.classList.remove('bg-gray-600', 'text-gray-300');
        tabContext.classList.add('bg-gray-800', 'text-white');
        tabCode.classList.remove('bg-gray-800', 'text-white');
        tabCode.classList.add('bg-gray-600', 'text-gray-300');
        panelContext.classList.remove('hidden');
        panelCode.classList.add('hidden');
      }
    }

    tabCode.addEventListener('click', () => switchTab('code'));
    tabContext.addEventListener('click', () => switchTab('context'));
    btnHelp.addEventListener('click', () => openModal('help'));

    // DÃ©tecter les modifications du contexte
    contextEditor.addEventListener('input', () => {
      if (contextEditor.value !== originalContext) {
        fileModifiedEl.classList.remove('hidden');
      } else if (editor.getValue() === originalCode) {
        fileModifiedEl.classList.add('hidden');
      }
    });

    // === Gestion des modales ===
    function openModal(type) {
      const modals = { new: modalNew, open: modalOpen, export: modalExport, help: modalHelp };
      const modal = modals[type];
      if (modal) {
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        if (type === 'new') loadTemplates();
        if (type === 'open') loadDocuments();
        if (type === 'export') updateExportOptions();
      }
    }

    // Mettre Ã  jour les options d'export selon le type de contenu
    function updateExportOptions() {
      const code = editor.getValue();
      const isTable = code.includes('table "');
      const isFlowchart = code.includes('flow "');
      const isSwimlane = code.includes('swimlane "');

      // Boutons diagrammes (SVG, PNG, PDF, JSON)
      document.querySelectorAll('.export-btn').forEach(btn => {
        if (isFlowchart || isTable || isSwimlane) {
          btn.disabled = false;
          btn.style.opacity = '1';
          btn.style.cursor = 'pointer';
        } else {
          btn.disabled = true;
          btn.style.opacity = '0.4';
          btn.style.cursor = 'not-allowed';
        }
      });

      // Boutons tableaux (ASCII, Markdown, HTML)
      document.querySelectorAll('.export-table-btn').forEach(btn => {
        if (isTable) {
          btn.disabled = false;
          btn.style.opacity = '1';
          btn.style.cursor = 'pointer';
        } else {
          btn.disabled = true;
          btn.style.opacity = '0.4';
          btn.style.cursor = 'not-allowed';
        }
      });

      // Boutons swimlanes (ASCII)
      document.querySelectorAll('.export-swimlane-btn').forEach(btn => {
        if (isSwimlane) {
          btn.disabled = false;
          btn.style.opacity = '1';
          btn.style.cursor = 'pointer';
        } else {
          btn.disabled = true;
          btn.style.opacity = '0.4';
          btn.style.cursor = 'not-allowed';
        }
      });
    }

    function closeModal(type) {
      const modals = { new: modalNew, open: modalOpen, export: modalExport, help: modalHelp };
      const modal = modals[type];
      if (modal) {
        modal.classList.add('hidden');
        document.body.style.overflow = '';
      }
    }

    // Fermer avec Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeModal('new');
        closeModal('open');
        closeModal('export');
        closeModal('help');
      }
    });

    // Boutons ouvrir modales
    btnNew.addEventListener('click', () => openModal('new'));
    btnOpen.addEventListener('click', () => openModal('open'));
    document.getElementById('btn-export').addEventListener('click', () => openModal('export'));

    // === Initialisation CodeMirror ===
    const editor = CodeMirror(document.getElementById('code-editor-wrapper'), {
      value: codeEditorTextarea.value,
      mode: "tiboflux",
      theme: "material-darker",
      lineNumbers: true,
      indentUnit: 2,
      tabSize: 2,
      indentWithTabs: false,
      lineWrapping: true,
      extraKeys: {
        "Tab": function(cm) {
          cm.replaceSelection("  ", "end");
        }
      }
    });

    // Wrapper pour compatibilitÃ© avec le code existant
    const codeEditor = {
      get value() { return editor.getValue(); },
      set value(v) { editor.setValue(v); }
    };

    // DÃ©tecter les modifications (Ã©vÃ©nement CodeMirror)
    editor.on('change', () => {
      if (editor.getValue() !== originalCode) {
        fileModifiedEl.classList.remove('hidden');
      } else {
        fileModifiedEl.classList.add('hidden');
      }
    });

    // Charger les templates
    async function loadTemplates() {
      try {
        templatesContent.innerHTML = '<div class="text-gray-500">Chargement...</div>';
        const response = await fetch('/api/documents/templates');
        const data = await response.json();
        if (data.success) {
          renderTemplatesContent(data.templates);
        }
      } catch (error) {
        templatesContent.innerHTML = '<div class="text-red-500">Erreur de chargement</div>';
      }
    }

    // Afficher les templates dans la modale
    function renderTemplatesContent(templates) {
      const flowcharts = templates.filter(t => t.type === 'flowchart');
      const tables = templates.filter(t => t.type === 'table');
      const swimlanes = templates.filter(t => t.type === 'swimlane');

      let html = '';

      if (flowcharts.length) {
        html += '<div class="mb-4"><h3 class="text-sm font-semibold text-gray-500 mb-2">Flowcharts</h3><div class="grid gap-2">';
        flowcharts.forEach(t => {
          html += `<button class="text-left p-3 border rounded-lg hover:bg-indigo-50 hover:border-indigo-300 transition" data-template-id="${t.id}">
            <div class="font-medium text-gray-800">${t.name}</div>
            <div class="text-xs text-gray-500">Template flowchart</div>
          </button>`;
        });
        html += '</div></div>';
      }

      if (swimlanes.length) {
        html += '<div class="mb-4"><h3 class="text-sm font-semibold text-gray-500 mb-2">Swimlanes</h3><div class="grid gap-2">';
        swimlanes.forEach(t => {
          html += `<button class="text-left p-3 border rounded-lg hover:bg-indigo-50 hover:border-indigo-300 transition" data-template-id="${t.id}">
            <div class="font-medium text-gray-800">${t.name}</div>
            <div class="text-xs text-gray-500">Template diagramme multi-acteurs</div>
          </button>`;
        });
        html += '</div></div>';
      }

      if (tables.length) {
        html += '<div><h3 class="text-sm font-semibold text-gray-500 mb-2">Tableaux</h3><div class="grid gap-2">';
        tables.forEach(t => {
          html += `<button class="text-left p-3 border rounded-lg hover:bg-indigo-50 hover:border-indigo-300 transition" data-template-id="${t.id}">
            <div class="font-medium text-gray-800">${t.name}</div>
            <div class="text-xs text-gray-500">Template tableau</div>
          </button>`;
        });
        html += '</div></div>';
      }

      if (!flowcharts.length && !tables.length && !swimlanes.length) {
        html = '<div class="text-gray-500 text-center py-4">Aucun template disponible</div>';
      }

      templatesContent.innerHTML = html;

      // Event listeners
      templatesContent.querySelectorAll('[data-template-id]').forEach(btn => {
        btn.addEventListener('click', () => {
          loadTemplate(btn.dataset.templateId);
          closeModal('new');
        });
      });
    }

    // Charger un template
    async function loadTemplate(id) {
      try {
        const response = await fetch(`/api/documents/${id}`);
        const data = await response.json();
        if (data.success) {
          currentDocument = null;
          codeEditor.value = data.document.code;
          originalCode = data.document.code;
          contextEditor.value = '';
          originalContext = '';
          currentFileEl.textContent = 'Nouveau (depuis ' + data.document.name + ')';
          fileModifiedEl.classList.add('hidden');
          btnDelete.classList.add('hidden');
          switchTab('code');
          log('Template chargÃ©: ' + data.document.name, 'success');
        }
      } catch (error) {
        log('Erreur chargement template: ' + error.message, 'error');
      }
    }

    // Charger les documents
    async function loadDocuments() {
      try {
        documentsContent.innerHTML = '<div class="text-gray-500">Chargement...</div>';
        const response = await fetch('/api/documents');
        const data = await response.json();
        if (data.success) {
          renderDocumentsContent(data.documents);
        }
      } catch (error) {
        documentsContent.innerHTML = '<div class="text-red-500">Erreur de chargement</div>';
      }
    }

    // Afficher les documents dans la modale
    function renderDocumentsContent(documents) {
      if (documents.length === 0) {
        documentsContent.innerHTML = '<div class="text-gray-500 text-center py-8"><p class="mb-2">Aucun document sauvegardÃ©</p><p class="text-sm">CrÃ©ez un nouveau document avec le bouton "Nouveau"</p></div>';
        return;
      }

      let html = '<div class="grid gap-2">';
      documents.forEach(doc => {
        const date = new Date(doc.updated_at).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', year: 'numeric' });
        const icons = { flowchart: 'ðŸ“Š', table: 'ðŸ“‹', swimlane: 'ðŸ‘¥' };
        const labels = { flowchart: 'Flowchart', table: 'Tableau', swimlane: 'Swimlane' };
        const icon = icons[doc.type] || 'ðŸ“„';
        const label = labels[doc.type] || doc.type;
        html += `<button class="text-left p-3 border rounded-lg hover:bg-indigo-50 hover:border-indigo-300 transition flex items-center gap-3" data-doc-id="${doc.id}">
          <span class="text-2xl">${icon}</span>
          <div class="flex-1">
            <div class="font-medium text-gray-800">${doc.name}</div>
            <div class="text-xs text-gray-500">${label} - ${date}</div>
          </div>
        </button>`;
      });
      html += '</div>';
      documentsContent.innerHTML = html;

      // Event listeners
      documentsContent.querySelectorAll('[data-doc-id]').forEach(btn => {
        btn.addEventListener('click', () => {
          loadDocument(btn.dataset.docId);
          closeModal('open');
        });
      });
    }

    // Charger un document
    async function loadDocument(id) {
      try {
        const response = await fetch(`/api/documents/${id}`);
        const data = await response.json();
        if (data.success) {
          currentDocument = data.document;
          codeEditor.value = data.document.code;
          originalCode = data.document.code;
          contextEditor.value = data.document.context || '';
          originalContext = data.document.context || '';
          currentFileEl.textContent = data.document.name;
          fileModifiedEl.classList.add('hidden');
          btnDelete.classList.remove('hidden');
          switchTab('code');
          log('Document ouvert: ' + data.document.name, 'success');
        }
      } catch (error) {
        log('Erreur chargement document: ' + error.message, 'error');
      }
    }

    // Sauvegarder
    btnSave.addEventListener('click', async () => {
      const code = codeEditor.value;
      const context = contextEditor.value;
      if (!code.trim()) {
        log('Le code ne peut pas Ãªtre vide', 'error');
        return;
      }

      // DÃ©tecter le type
      const type = code.includes('swimlane "') ? 'swimlane' : code.includes('table "') ? 'table' : 'flowchart';
      let name, shouldUpdate = false;

      if (currentDocument) {
        // Document existant - vÃ©rifier si modifiÃ©
        const hasChanges = code !== originalCode || context !== originalContext;

        if (hasChanges) {
          // Demander : Ã©craser ou copie ?
          const choice = confirm(
            `Le document "${currentDocument.name}" a Ã©tÃ© modifiÃ©.\n\n` +
            `OK = Ã‰craser la version existante\n` +
            `Annuler = CrÃ©er une copie (vous pourrez renommer)`
          );

          if (choice) {
            // Ã‰craser
            name = currentDocument.name;
            shouldUpdate = true;
          } else {
            // CrÃ©er une copie - demander le nouveau nom
            name = prompt('Nom de la copie :', currentDocument.name + ' (copie)');
            if (!name) return;
            shouldUpdate = false;
          }
        } else {
          // Pas de changement, sauvegarder directement
          name = currentDocument.name;
          shouldUpdate = true;
        }
      } else {
        // Nouveau document
        name = prompt('Nom du document :', 'Mon document');
        if (!name) return;
        shouldUpdate = false;
      }

      try {
        let response;
        if (shouldUpdate && currentDocument) {
          // Update
          response = await fetch(`/api/documents/${currentDocument.id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, code, context })
          });
        } else {
          // Create
          response = await fetch('/api/documents', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, code, type, context })
          });
        }

        const data = await response.json();
        if (data.success) {
          currentDocument = data.document;
          originalCode = code;
          originalContext = context;
          currentFileEl.textContent = data.document.name;
          fileModifiedEl.classList.add('hidden');
          btnDelete.classList.remove('hidden');
          loadDocuments(); // RafraÃ®chir la liste
          log('Document sauvegardÃ©: ' + data.document.name, 'success');
        } else {
          throw new Error(data.error);
        }
      } catch (error) {
        log('Erreur sauvegarde: ' + error.message, 'error');
      }
    });

    // Supprimer
    btnDelete.addEventListener('click', async () => {
      if (!currentDocument) return;

      if (!confirm(`Supprimer "${currentDocument.name}" ?`)) return;

      try {
        const response = await fetch(`/api/documents/${currentDocument.id}`, {
          method: 'DELETE'
        });
        const data = await response.json();
        if (data.success) {
          log('Document supprimÃ©: ' + currentDocument.name, 'success');
          currentDocument = null;
          codeEditor.value = '';
          originalCode = '';
          contextEditor.value = '';
          originalContext = '';
          currentFileEl.textContent = 'Nouveau document';
          fileModifiedEl.classList.add('hidden');
          btnDelete.classList.add('hidden');
          switchTab('code');
          loadDocuments();
        } else {
          throw new Error(data.error);
        }
      } catch (error) {
        log('Erreur suppression: ' + error.message, 'error');
      }
    });

    // Toggle console
    consoleHeader.addEventListener('click', () => {
      const isHidden = consoleWrapper.classList.toggle('hidden');
      consoleIcon.style.transform = isHidden ? '' : 'rotate(90deg)';
      if (!isHidden) {
        errorCount = 0;
        consoleBadge.classList.add('hidden');
      }
    });

    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const colors = { info: '#9ca3af', error: '#ef4444', success: '#22c55e' };
      consoleEl.innerHTML += `\n<span style="color:${colors[type]}">[${timestamp}] ${message}</span>`;
      consoleEl.scrollTop = consoleEl.scrollHeight;

      // En cas d'erreur, afficher la console automatiquement
      if (type === 'error') {
        consoleWrapper.classList.remove('hidden');
        consoleIcon.style.transform = 'rotate(90deg)';
      }
      // Si console fermÃ©e, afficher le badge avec compteur d'erreurs
      if (type === 'error' && consoleWrapper.classList.contains('hidden')) {
        errorCount++;
        consoleBadge.textContent = errorCount;
        consoleBadge.classList.remove('hidden');
      }
    }

    function setStatus(text, color = 'gray') {
      statusEl.textContent = text;
      statusEl.className = `text-xs text-${color}-500`;
    }

    document.getElementById('btn-render').addEventListener('click', async () => {
      try {
        setStatus('GÃ©nÃ©ration...', 'yellow');
        const response = await fetch('/api/render', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code: codeEditor.value })
        });
        const data = await response.json();
        if (data.success) {
          previewSvg.innerHTML = data.svg;
          log('Diagramme gÃ©nÃ©rÃ©', 'success');
          setStatus('OK', 'green');
        } else {
          throw new Error(data.error);
        }
      } catch (error) {
        log(`Erreur: ${error.message}`, 'error');
        setStatus('Erreur', 'red');
      }
    });

    document.querySelectorAll('[data-format]').forEach(btn => {
      btn.addEventListener('click', async () => {
        if (btn.disabled) return;
        const format = btn.dataset.format;
        try {
          setStatus(`Export ${format.toUpperCase()}...`, 'yellow');

          // Export JSON (AST) - tÃ©lÃ©chargement direct
          if (format === 'json') {
            const response = await fetch('/api/parse', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ code: codeEditor.value })
            });
            const data = await response.json();
            if (data.success) {
              // CrÃ©er et tÃ©lÃ©charger le fichier JSON
              const blob = new Blob([JSON.stringify(data.ast, null, 2)], { type: 'application/json' });
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = `diagram-${Date.now()}.json`;
              a.click();
              URL.revokeObjectURL(url);
              log('Export JSON rÃ©ussi', 'success');
              setStatus('ExportÃ©', 'green');
              closeModal('export');
            } else {
              throw new Error(data.error);
            }
            return;
          }

          // Export SVG/PNG/PDF via l'API
          const response = await fetch('/api/export', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: codeEditor.value, format })
          });
          const data = await response.json();
          if (data.success) {
            log(`Export ${format.toUpperCase()} rÃ©ussi: ${data.filename}`, 'success');
            if (data.url) {
              window.open(data.url, '_blank');
            }
            setStatus('ExportÃ©', 'green');
            closeModal('export');
          } else {
            throw new Error(data.error);
          }
        } catch (error) {
          log(`Erreur export: ${error.message}`, 'error');
          setStatus('Erreur', 'red');
        }
      });
    });

    // Export tableaux (ASCII, Markdown, HTML)
    document.querySelectorAll('[data-table-format]').forEach(btn => {
      btn.addEventListener('click', async () => {
        if (btn.disabled) return;
        const format = btn.dataset.tableFormat;
        try {
          setStatus(`Export ${format.toUpperCase()}...`, 'yellow');

          const response = await fetch('/api/export-table', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: codeEditor.value, format })
          });
          const data = await response.json();

          if (data.success) {
            // TÃ©lÃ©charger le fichier texte
            const extensions = { ascii: 'txt', markdown: 'md', html: 'html' };
            const blob = new Blob([data.content], { type: data.mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `table-${Date.now()}.${extensions[format] || 'txt'}`;
            a.click();
            URL.revokeObjectURL(url);
            log(`Export ${format.toUpperCase()} rÃ©ussi`, 'success');
            setStatus('ExportÃ©', 'green');
            closeModal('export');
          } else {
            throw new Error(data.error);
          }
        } catch (error) {
          log(`Erreur export: ${error.message}`, 'error');
          setStatus('Erreur', 'red');
        }
      });
    });

    // Export swimlanes (ASCII)
    document.querySelectorAll('[data-swimlane-format]').forEach(btn => {
      btn.addEventListener('click', async () => {
        if (btn.disabled) return;
        const format = btn.dataset.swimlaneFormat;
        try {
          setStatus(`Export ${format.toUpperCase()}...`, 'yellow');

          const response = await fetch('/api/export-swimlane', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: codeEditor.value, format })
          });
          const data = await response.json();

          if (data.success) {
            // TÃ©lÃ©charger le fichier texte
            const blob = new Blob([data.content], { type: data.mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `swimlane-${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            log(`Export ${format.toUpperCase()} rÃ©ussi`, 'success');
            setStatus('ExportÃ©', 'green');
            closeModal('export');
          } else {
            throw new Error(data.error);
          }
        } catch (error) {
          log(`Erreur export: ${error.message}`, 'error');
          setStatus('Erreur', 'red');
        }
      });
    });

    // Raccourci Ctrl+S pour sauvegarder
    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        btnSave.click();
      }
    });

    // Confirmation avant de quitter si modifications non sauvegardÃ©es
    window.addEventListener('beforeunload', (e) => {
      if (editor.getValue() !== originalCode || contextEditor.value !== originalContext) {
        e.preventDefault();
        e.returnValue = '';
      }
    });
